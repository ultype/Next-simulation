#!/bin/bash

if [ "$1" = "--help" ]; then
  echo "Please export the following required variables before running this script:"
  echo "For a guided variable setup run the script located under driver/scripts/cross_compile."
  echo ""
  echo "CC:                   Set to the target specific compiler command."
  echo "CIFX_HOST_MACHINE:    Set to the machine the source should be built 'for'"
  echo "                      e.g. export CIFX_HOST_MACHINE=\$(/bin/bash -c \"\$CC -dumpmachine\")"
  echo "CIFX_BUILD_MACHINE:   Set to the machine the source should be build 'on'"
  echo "                         default: gcc -dumpmachine"
  echo "PATH_TO_LIBPCIACCESS: Set to the path where the libpciaccess is located"
  echo "                      e.g. export PATH_TO_LIBPCIACCESS=/home/project/target/libs/"
  echo "                      NOTE: Set to empty string if libpciaccess is statically linked to libcifx."
  echo "PATH_TO_INCPCIACCESS: Set to the path where the libpciaccess header are located"
  echo ""
  echo "NOTE: Multiple (include) paths can be given via comma separated list."
  echo "      For more options run the provided configure script directly."
  exit
fi

if [ -n $1 ]; then
  USER_PARAM=$1
fi

if [ -z "${CC}" ]; then
  echo "Error - aborting build process! Compiler command not specified (environment variable CC)!"
  echo "For more information run this script with '--help'."
  echo "For a guided variable setup run the script located under driver/scripts/cross_compile."
  exit
fi

if [ -z $CIFX_HOST_MACHINE ]; then
  echo "Error - aborting build process! Host name not set (configure --host=xxx)!"
  echo "For more information run this script with '--help'."
  echo "For a guided variable setup run the script located under driver/scripts/cross_compile."
  exit
fi

if [ -z $CIFX_BUILD_MACHINE ]; then
  CIFX_BUILD_MACHINE=$(/bin/bash -c "gcc -dumpmachine")
fi

if [ -z $PATH_TO_LIBPCIACCESS ]; then
  echo "NOTE: Path to libpciaccess not specified (PATH_TO_LIBPCIACCESS)!"
  echo "      PATH_TO_LIBPCIACCESS can only be left empty if '--disable-pci' is specified!"
  echo "For more information run this script with '--help'."
  echo "For a guided variable setup run the script located under driver/scripts/cross_compile."
fi
if [ -z $PATH_TO_INCPCIACCESS ]; then
  echo "NOTE: Path to libpciaccess header not specified (PATH_TO_INCPCIACCESS)!"
  echo "      PATH_TO_INCPCIACCESS can only be left empty if '--disable-pci' is specified!"
  echo "For more information run this script with '--help'."
  echo "For a guided variable setup run the script located under driver/scripts/cross_compile."
fi

OIFS=$IFS;
IFS=",";

#pciaccess lib
INCPCIACCESS=($PATH_TO_INCPCIACCESS)
for (( i=0; i < ${#INCPCIACCESS[@]} ; i++ )) ;
do
  TMP_PCIACCESS_CFLAGS="${TMP_PCIACCESS_CFLAGS} -I${INCPCIACCESS[$i]}"
done

#pciaccess lib, in case the library is statically linked to libcifx this is not necessary
if [ -z ${PATH_TO_LIBPCIACCESS} ]; then
  TMP_PCIACESS_LIBS=""
else
  TMP_PCIACESS_LIBS="-lpciaccess -L${PATH_TO_LIBPCIACCESS}"
fi

IFS=$OIFS;

./configure "${USER_PARAM}" --build=${CIFX_BUILD_MACHINE} --host=${CIFX_HOST_MACHINE} PCIACCESS_CFLAGS="${TMP_PCIACCESS_CFLAGS}" PCIACCESS_LIBS="${TMP_PCIACESS_LIBS}"

